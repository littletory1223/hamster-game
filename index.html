<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>í–„ìŠ¤í„° ì›”ë“œ - í¼í™íŠ¸ ë²„ì „</title>
    <link href="https://fonts.googleapis.com/css2?family=Jua&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        body {
            text-align: center;
            background-color: #E3F2FD;
            font-family: 'Jua', sans-serif;
            margin: 0; padding: 0;
            overflow: hidden;
            user-select: none;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            touch-action: none;
        }

        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* ğŸ”’ ë¡œê·¸ì¸ */
        #loginScreen {
            background-color: white; padding: 30px; border-radius: 30px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1); width: 90%; max-width: 350px; border: 5px solid #00BCD4;
        }
        #loginScreen h1 { color: #0097A7; margin-bottom: 20px; font-size: 2rem; }
        .login-input { width: 80%; padding: 12px; margin-bottom: 20px; border: 2px solid #B2EBF2; border-radius: 15px; font-size: 1.1rem; font-family: 'Jua'; outline: none; text-align: center; }
        .login-btn { width: 90%; padding: 12px; background-color: #00BCD4; color: white; border: none; border-radius: 15px; font-size: 1.3rem; font-family: 'Jua'; cursor: pointer; }
        .error-msg { color: #FF5252; font-size: 0.9rem; height: 20px; margin-bottom: 5px; }

        /* ğŸ  í™ˆ */
        #homeScreen {
            background-color: white; padding: 20px; border-radius: 20px; border: 5px solid #FF9800;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); width: 90%; max-width: 600px;
            max-height: 95vh; overflow-y: auto;
        }
        .welcome-msg { text-align: right; margin-bottom: 10px; font-size: 1rem; }
        .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; text-align: left; margin-bottom: 15px; }
        .input-box input { width: 90%; padding: 5px; border: 2px solid #FFE0B2; border-radius: 8px; font-family: 'Jua'; text-align: center; }
        .btn-group { display: flex; gap: 10px; }
        button.big-btn { flex: 1; padding: 12px; border-radius: 12px; border: none; color: white; font-family: 'Jua'; font-size: 1.1rem; cursor: pointer; }
        #startBtn { background-color: #FF5252; } #checkBtn { background-color: #78909C; }

        /* ğŸ”§ ì ê²€ í™”ë©´ */
        #debugScreen {
            background-color: #263238; color: #00E676; font-family: 'Share Tech Mono', monospace;
            padding: 20px; border-radius: 10px; border: 2px solid #00E676; width: 95%; max-width: 600px; text-align: left; outline: none;
        }
        .debug-container { display: flex; justify-content: space-between; align-items: flex-start; }
        
        /* ì ê²€ìš© ê°€ìƒ í‚¤ë³´ë“œ */
        .debug-controls { margin-top: 10px; display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .d-key-row { display: flex; gap: 5px; }
        .d-key {
            width: 45px; height: 45px; border: 2px solid #00E676; color: #00E676;
            display: flex; align-items: center; justify-content: center; font-size: 20px;
            border-radius: 8px; cursor: pointer; user-select: none;
        }
        .d-key:active, .key-active { background-color: #00E676; color: #000; }

        #logBox { margin-top: 15px; background: black; padding: 5px; height: 60px; overflow-y: scroll; color: #ccc; font-size: 0.8rem; border: 1px solid #00E676; }
        #backBtn { background-color: #37474F; width: 100%; margin-top: 10px; padding: 10px; border: none; color: white; font-family: 'Share Tech Mono'; cursor: pointer; }

        /* ğŸ® ê²Œì„ í™”ë©´ */
        #gameScreen { position: relative; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        canvas { background-color: #fff; border: 4px solid #546E7A; border-radius: 15px; max-width: 98vw; max-height: 60vh; width: auto; height: auto; display: block; }
        #uiLayer { position: absolute; top: 10px; width: 90%; display: flex; justify-content: space-between; pointer-events: none; font-size: 1.2rem; color: #37474F; font-weight: bold; }
        #homeBtn { position: absolute; top: 50px; right: 10px; background: rgba(84,110,122,0.8); color: white; border: none; padding: 5px 10px; border-radius: 8px; font-family: 'Jua'; pointer-events: auto; cursor: pointer;}

        /* ğŸ“± ëª¨ë°”ì¼ ì»¨íŠ¸ë¡¤ëŸ¬ */
        #mobileControls { margin-top: 15px; display: flex; flex-direction: column; align-items: center; gap: 8px; }
        .control-row { display: flex; gap: 15px; }
        .m-btn {
            width: 65px; height: 65px; background-color: rgba(0,0,0,0.1);
            border: 2px solid rgba(0,0,0,0.3); border-radius: 50%;
            color: #37474F; font-size: 30px; display: flex; align-items: center; justify-content: center;
            cursor: pointer; -webkit-tap-highlight-color: transparent;
        }
        .m-btn:active { background-color: rgba(0,0,0,0.3); transform: scale(0.95); }

    </style>
</head>

<body>

    <div id="loginScreen" class="fade-in">
        <h1>ğŸ¹ í–„ìŠ¤í„° ì›”ë“œ</h1>
        <div class="error-msg" id="loginError"></div>
        <input type="text" id="userId" class="login-input" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
        <button class="login-btn" onclick="tryLogin()">ì…ì¥í•˜ê¸° ğŸš€</button>
    </div>

    <div id="homeScreen" class="hidden">
        <div class="welcome-msg">
            <span id="displayUser">ê²ŒìŠ¤íŠ¸</span>ë‹˜ <button style="background:#90A4AE; border:none; color:white; border-radius:5px; padding:2px 8px; font-family:'Jua';" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
        <h1 style="color:#EF6C00; margin:0 0 10px 0; font-size:1.8rem;">ğŸ® ì„¤ì •</h1>
        
        <div class="input-box" style="margin-bottom: 10px;">
            <label>ğŸ“ ì œëª©</label><input type="text" id="ruleTitle" value="ì „ì„¤ì˜ ë¯¸ë¡œ" style="width: 95%;">
        </div>
        <div class="settings-grid">
            <div class="input-box"><label>ğŸ† ë‚œì´ë„</label><input type="number" id="ruleLevel" value="3" min="1" max="10"></div>
            <div class="input-box"><label>â¤ï¸ ëª©ìˆ¨</label><input type="number" id="ruleLives" value="3" min="1" max="100"></div>
            <div class="input-box"><label>â° ì‹œê°„</label><input type="number" id="ruleTime" value="60" min="10"></div>
            <div class="input-box"><label>ğŸ§± ë²½(ë°€ë„)</label><input type="number" id="ruleWall" value="30" min="0" max="100"></div>
            <div class="input-box"><label>ğŸ‘» ìœ ë ¹</label><input type="number" id="ruleGhost" value="3" min="0" max="50"></div>
            <div class="input-box"><label>ğŸƒ ì†ë„</label><input type="number" id="ruleSpeed" value="7" min="1" max="15"></div>
        </div>
        <div class="btn-group">
            <button class="big-btn" id="checkBtn" onclick="goToDebug()">ğŸ”§ ì ê²€</button>
            <button class="big-btn" id="startBtn" onclick="goToGame()">â–¶ï¸ ì‹œì‘</button>
        </div>
    </div>

    <div id="debugScreen" class="hidden" tabindex="0">
        <h2>ğŸ› ï¸ SYSTEM CHECK</h2>
        <div class="debug-container">
            <div style="flex:1;">
                <p style="font-size:0.8rem; margin-bottom:5px;">TOUCH TEST</p>
                <div class="debug-controls">
                    <div class="d-key" id="dUp" onmousedown="handleDebugKey('up',true)" onmouseup="handleDebugKey('up',false)" ontouchstart="handleDebugKey('up',true)" ontouchend="handleDebugKey('up',false)">â–²</div>
                    <div class="d-key-row">
                        <div class="d-key" id="dLeft" onmousedown="handleDebugKey('left',true)" onmouseup="handleDebugKey('left',false)" ontouchstart="handleDebugKey('left',true)" ontouchend="handleDebugKey('left',false)">â—€</div>
                        <div class="d-key" id="dDown" onmousedown="handleDebugKey('down',true)" onmouseup="handleDebugKey('down',false)" ontouchstart="handleDebugKey('down',true)" ontouchend="handleDebugKey('down',false)">â–¼</div>
                        <div class="d-key" id="dRight" onmousedown="handleDebugKey('right',true)" onmouseup="handleDebugKey('right',false)" ontouchstart="handleDebugKey('right',true)" ontouchend="handleDebugKey('right',false)">â–¶</div>
                    </div>
                </div>
            </div>
            <div style="margin-left:10px;">
                <p style="font-size:0.8rem; margin-bottom:5px;">PREVIEW</p>
                <canvas id="debugCanvas" width="160" height="120" style="border:1px solid #00E676; background:#111; border-radius:5px;"></canvas>
            </div>
        </div>
        <div id="logBox"></div>
        <button id="backBtn" onclick="exitDebug()">[ EXIT ]</button>
    </div>

    <div id="gameScreen" class="hidden">
        <div id="uiLayer"><span id="uiLives">â¤ï¸ 3</span><span id="uiTitle">ì œëª©</span><span id="uiTime">â° 60</span></div>
        <button id="homeBtn" onclick="goToHome()">ğŸ  í™ˆ</button>
        <canvas id="gameCanvas" width="800" height="500"></canvas>
        <div id="mobileControls">
            <div class="m-btn" id="mUp">â–²</div>
            <div class="control-row">
                <div class="m-btn" id="mLeft">â—€</div>
                <div class="m-btn" id="mDown">â–¼</div>
                <div class="m-btn" id="mRight">â–¶</div>
            </div>
        </div>
    </div>

    <script>
        // --- ì „ì—­ ë³€ìˆ˜ ---
        let currentUser = "";
        const loginScreen = document.getElementById("loginScreen");
        const homeScreen = document.getElementById("homeScreen");
        const debugScreen = document.getElementById("debugScreen");
        const gameScreen = document.getElementById("gameScreen");

        // --- ë¡œê·¸ì¸ ---
        function tryLogin() {
            const id = document.getElementById("userId").value;
            if(!id.trim()) { document.getElementById("loginError").innerText="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”!"; return; }
            currentUser = id; document.getElementById("displayUser").innerText = currentUser;
            loginScreen.classList.add("hidden"); homeScreen.classList.remove("hidden");
            document.body.style.backgroundColor = "#FFF3E0";
        }
        function logout() {
            document.getElementById("userId").value = "";
            homeScreen.classList.add("hidden"); loginScreen.classList.remove("hidden");
            document.body.style.backgroundColor = "#E3F2FD";
        }

        // --- í™”ë©´ ì „í™˜ ---
        function goToGame() {
            let t = document.getElementById("ruleTitle").value;
            let wd = parseInt(document.getElementById("ruleWall").value);
            let l = parseInt(document.getElementById("ruleLevel").value);
            let g = parseInt(document.getElementById("ruleGhost").value);
            let hp = parseInt(document.getElementById("ruleLives").value);
            let sp = parseInt(document.getElementById("ruleSpeed").value);
            let tm = parseInt(document.getElementById("ruleTime").value);
            if(wd<0)wd=0; if(wd>100)wd=100;
            initGame(t, wd, l, g, hp, sp, tm);
            homeScreen.classList.add("hidden"); gameScreen.classList.remove("hidden");
            document.body.style.backgroundColor = "#37474F";
        }
        function goToHome() {
            isGameOver=true; isGameRunning=false;
            gameScreen.classList.add("hidden"); homeScreen.classList.remove("hidden");
            document.body.style.backgroundColor = "#FFF3E0";
        }
        function goToDebug() {
            homeScreen.classList.add("hidden"); debugScreen.classList.remove("hidden");
            document.body.style.backgroundColor = "#111";
            isDebugMode = true; addLog("Diagnostic Mode Ready.");
            // ì ê²€ìš© ì´ˆê¸°í™”
            debugPos={x:80,y:60,speed:2,frozen:false,shield:false};
            debugGhosts=[{x:20,y:20,vx:1.5,vy:1.5},{x:140,y:100,vx:-1.5,vy:-1}];
            debugItems=[]; debugStats={lives:3,score:0,hitTimer:0};
            debugScreen.focus(); debugLoop();
        }
        function exitDebug() {
            isDebugMode = false; debugScreen.classList.add("hidden"); homeScreen.classList.remove("hidden");
            document.body.style.backgroundColor = "#FFF3E0";
        }

        // --- â˜… ì ê²€ ëª¨ë“œ ë¡œì§ (í„°ì¹˜ ì§€ì›) â˜… ---
        const dCtx = document.getElementById("debugCanvas").getContext("2d");
        const logBox = document.getElementById("logBox");
        let isDebugMode=false;
        let debugPos={x:80,y:60,speed:2,frozen:false,shield:false};
        let debugKeys={up:false,down:false,left:false,right:false};
        let debugGhosts=[], debugItems=[], debugStats={lives:3,score:0,hitTimer:0};
        let debugTimer=null;

        function addLog(m) { logBox.innerHTML=`> ${m}<br>`+logBox.innerHTML; }
        
        // ì ê²€ í™”ë©´ ë²„íŠ¼ í•¸ë“¤ëŸ¬
        function handleDebugKey(dir, pressed) {
            // ì´ë²¤íŠ¸ ë²„ë¸”ë§ ë°©ì§€
            if(event) { event.preventDefault(); event.stopPropagation(); }
            
            if(dir=='up') debugKeys.up = pressed;
            if(dir=='down') debugKeys.down = pressed;
            if(dir=='left') debugKeys.left = pressed;
            if(dir=='right') debugKeys.right = pressed;
            
            let elId = 'd' + dir.charAt(0).toUpperCase() + dir.slice(1);
            let el = document.getElementById(elId);
            if(pressed) el.classList.add('key-active'); else el.classList.remove('key-active');
        }

        function resetDebugEffect(){debugPos.speed=2;debugPos.frozen=false;debugPos.shield=false;if(debugTimer)clearTimeout(debugTimer);}

        function debugLoop() {
            if(!isDebugMode) return;
            dCtx.clearRect(0,0,160,120);
            
            // ê²Œì„ì˜¤ë²„ ë¦¬ì…‹
            if(debugStats.lives<=0){
                dCtx.fillStyle="red";dCtx.font="16px Arial";dCtx.textAlign="center";dCtx.fillText("GAME OVER",80,60);
                if(Math.random()<0.05){debugStats.lives=3;debugStats.score=0;debugPos.x=80;debugPos.y=60;addLog("Reseting...");}
                requestAnimationFrame(debugLoop); return;
            }

            // ì•„ì´í…œ ìƒì„±
            if(debugItems.length<2 && Math.random()<0.03){
                let types=["âš¡","ğŸ¢","ğŸ›¡ï¸","ğŸ§Š","â­"]; let t=types[Math.floor(Math.random()*types.length)];
                debugItems.push({x:10+Math.random()*140,y:10+Math.random()*100,type:t});
            }

            // ì´ë™ (ë²½ ì¶©ëŒ ë°©ì§€)
            if(!debugPos.frozen){
                if(debugKeys.up && debugPos.y>10) debugPos.y-=debugPos.speed;
                if(debugKeys.down && debugPos.y<110) debugPos.y+=debugPos.speed;
                if(debugKeys.left && debugPos.x>10) debugPos.x-=debugPos.speed;
                if(debugKeys.right && debugPos.x<150) debugPos.x+=debugPos.speed;
            }

            // ì•„ì´í…œ
            for(let i=debugItems.length-1; i>=0; i--){
                let it=debugItems[i]; dCtx.font="14px Arial"; dCtx.textAlign="center"; dCtx.textBaseline="middle"; dCtx.fillText(it.type,it.x,it.y);
                if(Math.abs(debugPos.x-it.x)<12 && Math.abs(debugPos.y-it.y)<12){
                    debugItems.splice(i,1);
                    if(it.type=="â­"){debugStats.score+=100; addLog("Score +100");}
                    else{
                        resetDebugEffect();
                        if(it.type=="âš¡"){debugPos.speed=4;addLog("FAST!");} if(it.type=="ğŸ¢"){debugPos.speed=0.5;addLog("SLOW..");}
                        if(it.type=="ğŸ›¡ï¸"){debugPos.shield=true;addLog("SHIELD");} if(it.type=="ğŸ§Š"){debugPos.frozen=true;addLog("FROZEN");}
                        debugTimer=setTimeout(resetDebugEffect,2000);
                    }
                }
            }

            // ìœ ë ¹ & ì¶©ëŒ
            if(debugStats.hitTimer>0) debugStats.hitTimer--;
            let hit=false;
            for(let g of debugGhosts){
                g.x+=g.vx; g.y+=g.vy;
                if(g.x<10||g.x>150)g.vx*=-1; if(g.y<10||g.y>110)g.vy*=-1;
                dCtx.font="16px Arial"; dCtx.fillText("ğŸ‘»",g.x,g.y);
                if(!debugPos.shield && debugStats.hitTimer==0 && Math.abs(debugPos.x-g.x)<15 && Math.abs(debugPos.y-g.y)<15){
                    hit=true; debugStats.lives--; debugStats.hitTimer=60; addLog("HIT! Ouch!");
                }
            }

            // í–„ìŠ¤í„°
            if(debugStats.hitTimer%10<5){
                let emo="ğŸ¹"; if(debugPos.frozen)emo="ğŸ¥¶"; if(debugPos.shield)emo="ğŸ˜";
                dCtx.fillText(emo,debugPos.x,debugPos.y);
            }

            // UI
            dCtx.fillStyle="white"; dCtx.font="10px monospace"; dCtx.textAlign="left"; dCtx.fillText("â¤ï¸"+debugStats.lives,5,10);
            dCtx.textAlign="right"; dCtx.fillText("â­"+debugStats.score,155,10);
            if(hit||debugStats.hitTimer>0){dCtx.strokeStyle="red";dCtx.lineWidth=2;}else{dCtx.strokeStyle="#00E676";dCtx.lineWidth=1;}
            dCtx.strokeRect(0,0,160,120);
            requestAnimationFrame(debugLoop);
        }


        // --- â˜… ë©”ì¸ ê²Œì„ ì—”ì§„ (ê°œì„ ëœ ë²„ì „) â˜… ---
        const canvas = document.getElementById("gameCanvas");
        const ctx = canvas.getContext("2d");
        const uiTitle = document.getElementById("uiTitle");
        const uiLives = document.getElementById("uiLives");
        const uiTime = document.getElementById("uiTime");
        
        let player={x:0,y:0,size:22,speed:5,baseSpeed:5,invinc:false,confuse:false,freeze:false};
        let walls=[], items=[], enemies=[], particles=[];
        let keys={right:false,left:false,up:false,down:false};
        let lives=3, timeLeft=60, isGameOver=false, isGameRunning=false, gameOverReason="";
        let effectTimer=null; const CELL_SIZE=40;
        let gameSettings={};

        // ì•ˆì „í•œ ìŠ¤í° (ë²½ ì²´í¬ ê°•í™”)
        function findSafeSpot(){
            let maxAttempts=200;
            while(maxAttempts--){
                let c=Math.floor(Math.random()*20), r=Math.floor(Math.random()*12);
                if(c<2 && r<2) continue; // ì‹œì‘ì  ê·¼ì²˜ ì œì™¸
                let x=c*CELL_SIZE+10, y=r*CELL_SIZE+10;
                
                // ì‹¤ì œ ë²½ê³¼ ê²¹ì¹˜ëŠ”ì§€ í™•ì¸
                let safe=true;
                for(let w of walls){
                    // í”Œë ˆì´ì–´ë³´ë‹¤ ì•½ê°„ í° ì˜ì—­ìœ¼ë¡œ ì²´í¬
                    if(rectIntersect(x-5, y-5, 30, 30, w.x, w.y, w.w, w.h)) { safe=false; break; }
                }
                if(safe) return {x,y};
            }
            return {x:100, y:100}; // ë¹„ìƒì‹œ
        }

        function initGame(title, density, level, ghostCnt, lifeCnt, speed, time) {
            uiTitle.innerText = title; lives = lifeCnt; timeLeft = time;
            player.baseSpeed = speed; player.speed = speed;
            gameSettings={level,lives:lifeCnt,time};
            isGameOver=false; isGameRunning=true; gameOverReason="";
            
            // ë§µ ìƒì„±
            let maze = generateMaze(density); walls = createWalls(maze);
            
            // í”Œë ˆì´ì–´ ì´ˆê¸°í™” (í•­ìƒ ì•ˆì „í•œ 1,1 ìœ„ì¹˜)
            player.x=CELL_SIZE+5; player.y=CELL_SIZE+5; 
            resetStatus();
            items=[]; enemies=[]; particles=[];

            // ëª©í‘œ
            items.push({x:canvas.width-60, y:canvas.height-60, size:40, type:"goal", color:"gold", active:true});
            // ì•„ì´í…œ
            let types=["speedUp","speedDown","shield","confusion","freeze","heart"];
            for(let i=0;i<6;i++){
                let s=findSafeSpot(); let t=types[Math.floor(Math.random()*types.length)];
                items.push({x:s.x,y:s.y,size:20,type:t,color:getItemColor(t),active:true});
            }
            // ìœ ë ¹
            for(let i=0;i<ghostCnt;i++){
                let s=findSafeSpot(); let ax=Math.random()>0.5?'x':'y';
                // ìœ ë ¹ AI ì¶”ê°€: ë°©í–¥ ì „í™˜ íƒ€ì´ë¨¸
                enemies.push({
                    x:s.x, y:s.y, size:26, speed:Math.max(1.5, speed*0.4), 
                    axis:ax, dir:1, changeTimer:0
                });
            }
            canvas.focus();
        }

        function generateMaze(density){
            let cols=Math.floor(canvas.width/CELL_SIZE), rows=Math.floor(canvas.height/CELL_SIZE);
            let grid=[]; for(let r=0;r<rows;r++){let row=[];for(let c=0;c<cols;c++)row.push({x:c,y:r,v:false,w:{t:1,r:1,b:1,l:1}}); grid.push(row);}
            let cur=grid[0][0]; cur.v=true; let stack=[cur];
            while(stack.length){
                let ns=[], {x,y}=cur;
                if(y>0&&!grid[y-1][x].v)ns.push({d:'t',c:grid[y-1][x]}); if(x<cols-1&&!grid[y][x+1].v)ns.push({d:'r',c:grid[y][x+1]});
                if(y<rows-1&&!grid[y+1][x].v)ns.push({d:'b',c:grid[y+1][x]}); if(x>0&&!grid[y][x-1].v)ns.push({d:'l',c:grid[y][x-1]});
                if(ns.length){
                    let n=ns[Math.floor(Math.random()*ns.length)];
                    if(n.d=='t'){cur.w.t=0;n.c.w.b=0;}if(n.d=='r'){cur.w.r=0;n.c.w.l=0;}
                    if(n.d=='b'){cur.w.b=0;n.c.w.t=0;}if(n.d=='l'){cur.w.l=0;n.c.w.r=0;}
                    n.c.v=true; stack.push(cur); cur=n.c;
                } else cur=stack.pop();
            }
            let total=rows*cols;
            let percentToRemove = (100 - density) / 100;
            if(percentToRemove<0)percentToRemove=0; if(percentToRemove>1)percentToRemove=1;
            let rm=Math.floor(total*percentToRemove); if(rm<5)rm=5; // ìµœì†Œí•œì˜ ê¸¸ì€ ë³´ì¥
            for(let i=0;i<rm;i++){
                let r=Math.floor(Math.random()*(rows-1)), c=Math.floor(Math.random()*(cols-1));
                if(Math.random()>0.5){grid[r][c].w.r=0; grid[r][c+1].w.l=0;} else{grid[r][c].w.b=0; grid[r+1][c].w.t=0;}
            }
            return grid;
        }
        function createWalls(grid){
            let w=[]; let cols=grid[0].length, rows=grid.length;
            w.push({x:0,y:0,w:canvas.width,h:10}); w.push({x:0,y:canvas.height-10,w:canvas.width,h:10});
            w.push({x:0,y:0,w:10,h:canvas.height}); w.push({x:canvas.width-10,y:0,w:10,h:canvas.height});
            for(let r=0;r<rows;r++){for(let c=0;c<cols;c++){let cell=grid[r][c], x=c*CELL_SIZE, y=r*CELL_SIZE;
            if(cell.w.r)w.push({x:x+CELL_SIZE-2,y:y,w:4,h:CELL_SIZE}); if(cell.w.b)w.push({x:x,y:y+CELL_SIZE-2,w:CELL_SIZE,h:4});}}
            return w;
        }
        function getItemColor(t){return t=="speedUp"?"#2979FF":t=="speedDown"?"#AA00FF":t=="shield"?"#00C853":t=="heart"?"#D50000":t=="confusion"?"#FF6D00":t=="freeze"?"#00E5FF":"white";}
        function resetStatus(){if(effectTimer)clearTimeout(effectTimer); player.speed=player.baseSpeed; player.invinc=false; player.confuse=false; player.freeze=false;}

        // --- ì¡°ì‘ (ê²Œì„) ---
        const mBtns={up:document.getElementById('mUp'),down:document.getElementById('mDown'),left:document.getElementById('mLeft'),right:document.getElementById('mRight')};
        for(let d in mBtns){
            mBtns[d].addEventListener('touchstart',e=>{e.preventDefault(); keys[d]=true;});
            mBtns[d].addEventListener('touchend',e=>{e.preventDefault(); keys[d]=false;});
            mBtns[d].addEventListener('mousedown',()=>keys[d]=true);
            mBtns[d].addEventListener('mouseup',()=>keys[d]=false);
        }
        document.addEventListener("keydown",e=>{
            if(!isGameRunning){if(e.key==="Enter"&&!loginScreen.classList.contains("hidden"))tryLogin(); return;}
            if(e.key=="ArrowRight")keys.right=true; if(e.key=="ArrowLeft")keys.left=true;
            if(e.key=="ArrowUp")keys.up=true; if(e.key=="ArrowDown")keys.down=true;
            if(e.code=="Space"&&isGameOver) goToHome();
        });
        document.addEventListener("keyup",e=>{
            if(e.key=="ArrowRight")keys.right=false; if(e.key=="ArrowLeft")keys.left=false;
            if(e.key=="ArrowUp")keys.up=false; if(e.key=="ArrowDown")keys.down=false;
        });

        function loop(){if(isGameRunning){update(); draw();} requestAnimationFrame(loop);}

        // â˜… ìŠ¬ë¼ì´ë”© ì¶©ëŒ ì²´í¬ (í•µì‹¬) â˜…
        function checkCollision(x, y) {
            for(let w of walls) {
                if(rectIntersect(x, y, player.size, player.size, w.x, w.y, w.w, w.h)) return true;
            }
            return false;
        }

        function update(){
            if(isGameOver)return;
            for(let i=particles.length-1;i>=0;i--){particles[i].x+=particles[i].vx; particles[i].y+=particles[i].vy; particles[i].life-=0.05; if(particles[i].life<=0)particles.splice(i,1);}
            timeLeft-=1/60; if(timeLeft<=0){timeLeft=0; isGameOver=true; gameOverReason="time";}
            uiTime.innerText="â° "+Math.ceil(timeLeft); uiLives.innerText="â¤ï¸ "+lives;

            // ìœ ë ¹ AI ê°œì„ 
            for(let e of enemies){
                // ë°©í–¥ ë³€ê²½ íƒ€ì´ë¨¸
                e.changeTimer++;
                if(e.changeTimer > 100 && Math.random() < 0.05) {
                    e.changeTimer = 0;
                    e.dir *= -1; // ê°€ë” ë°˜ëŒ€ë¡œ
                }

                // ì´ë™
                let ex = e.x, ey = e.y;
                if(e.axis=='x') ex += e.speed*e.dir; else ey += e.speed*e.dir;

                // ë²½ ì¶©ëŒ ì²´í¬
                let hitWall = false;
                for(let w of walls) {
                    if(rectIntersect(ex, ey, e.size, e.size, w.x, w.y, w.w, w.h)) {
                        hitWall = true; break;
                    }
                }

                if(hitWall) {
                    e.dir *= -1; // ì¦‰ì‹œ ë°˜ëŒ€ ë°©í–¥
                    // ë¼ì„ ë°©ì§€: ì¡°ê¸ˆ ë°€ì–´ëƒ„
                    if(e.axis=='x') e.x += e.speed*e.dir*2; else e.y += e.speed*e.dir*2;
                } else {
                    e.x = ex; e.y = ey;
                }

                if(!player.invinc && rectColl(player,e)) hit("ghost");
            }

            if(player.freeze)return;

            // â˜… í”Œë ˆì´ì–´ ìŠ¬ë¼ì´ë”© ì´ë™ (X, Y ë¶„ë¦¬ ì²´í¬) â˜…
            let mx=0, my=0;
            if(keys.right)mx+=player.speed; if(keys.left)mx-=player.speed;
            if(keys.up)my-=player.speed; if(keys.down)my+=player.speed;
            if(player.confuse){mx=-mx; my=-my;}

            // Xì¶• ì´ë™ ì‹œë„
            let nextX = player.x + mx;
            nextX = Math.max(0, Math.min(canvas.width-player.size, nextX));
            if(!checkCollision(nextX, player.y)) {
                player.x = nextX;
            }

            // Yì¶• ì´ë™ ì‹œë„
            let nextY = player.y + my;
            nextY = Math.max(0, Math.min(canvas.height-player.size, nextY));
            if(!checkCollision(player.x, nextY)) {
                player.y = nextY;
            }

            // ì•„ì´í…œ ì¶©ëŒ
            for(let i of items){
                if(i.active && rectColl(player,i)){
                    createPart(i.x+10,i.y+10,i.color); i.active=false;
                    if(i.type=="goal"){isGameOver=true; gameOverReason="clear";} else applyItem(i);
                }
            }
        }

        function rectColl(a,b){return rectIntersect(a.x,a.y,a.size,a.size,b.x,b.y,b.size,b.size);}
        function rectIntersect(x1,y1,w1,h1,x2,y2,w2,h2){return x2<x1+w1 && x2+w2>x1 && y2<y1+h1 && y2+h2>y1;}
        
        function hit(t){
            lives--; createPart(player.x+10,player.y+10,"red"); 
            resetStatus(); player.invinc=true; setTimeout(()=>{player.invinc=false},1000); // 1ì´ˆ ë¬´ì 
            // ì‹œì‘ ìœ„ì¹˜ë¡œ ë³´ë‚´ëŠ” ëŒ€ì‹ , ì‚´ì§ íŠ•ê²¨ë‚´ê±°ë‚˜ ì œìë¦¬ ìœ ì§€ (ë¼ì„ ë°©ì§€)
            if(lives<=0){isGameOver=true; gameOverReason="life";}
        }
        function createPart(x,y,c){for(let i=0;i<8;i++)particles.push({x,y,vx:(Math.random()-.5)*10,vy:(Math.random()-.5)*10,life:1,color:c});}
        function applyItem(i){
            resetStatus();
            if(i.type=="heart")lives++; else if(i.type=="speedUp"){player.speed*=2; resetAfter(3000);}
            else if(i.type=="speedDown"){player.speed=2; resetAfter(3000);} else if(i.type=="shield"){player.invinc=true; resetAfter(3000);}
            else if(i.type=="confusion"){player.confuse=true; resetAfter(3000);} else if(i.type=="freeze"){player.freeze=true; resetAfter(2000);}
        }
        function resetAfter(ms){effectTimer=setTimeout(resetStatus, ms);}

        function draw(){
            ctx.clearRect(0,0,canvas.width,canvas.height);
            ctx.fillStyle="#78909C"; for(let w of walls)ctx.fillRect(w.x,w.y,w.w,w.h);
            ctx.textAlign="center"; ctx.textBaseline="middle";
            for(let i of items){if(i.active){let ico="â“"; if(i.type=="goal"){ico="â­";ctx.font="40px Arial";}else{ctx.font="24px Arial";
            if(i.type=="speedUp")ico="âš¡";if(i.type=="speedDown")ico="ğŸ¢";if(i.type=="shield")ico="ğŸ›¡ï¸";if(i.type=="heart")ico="â¤ï¸";if(i.type=="confusion")ico="ğŸ˜µ";if(i.type=="freeze")ico="ğŸ§Š";}
            ctx.fillText(ico,i.x+i.size/2,i.y+i.size/2);}}
            ctx.font="30px Arial"; for(let e of enemies)ctx.fillText("ğŸ‘»",e.x+e.size/2,e.y+e.size/2);
            
            // í”Œë ˆì´ì–´
            let px=player.x+player.size/2, py=player.y+player.size/2, emo="ğŸ¹";
            if(player.freeze)emo="ğŸ¥¶"; else if(player.confuse)emo="ğŸ˜µâ€ğŸ’«"; else if(player.invinc)emo="ğŸ˜"; else if(player.speed>=10)emo="ğŸš€";
            ctx.fillText(emo,px,py); if(player.invinc){ctx.strokeStyle="white"; ctx.lineWidth=3; ctx.beginPath(); ctx.arc(px,py,18,0,Math.PI*2); ctx.stroke();}
            
            for(let p of particles){ctx.globalAlpha=p.life; ctx.fillStyle=p.color; ctx.beginPath(); ctx.arc(p.x,p.y,5,0,Math.PI*2); ctx.fill();} ctx.globalAlpha=1.0;
            
            if(isGameOver){
                ctx.fillStyle="rgba(0,0,0,0.8)"; ctx.fillRect(0,0,canvas.width,canvas.height); ctx.fillStyle="white"; ctx.font="60px 'Jua'"; ctx.textAlign="center";
                let t="", s="", score=0;
                if(gameOverReason=="clear"){
                    t="ğŸ‰ ì„±ê³µ!"; s="ìŠ¤í˜ì´ìŠ¤ë°” = í™ˆìœ¼ë¡œ";
                    score = (gameSettings.level*1000) + (lives*500) + (Math.floor(timeLeft)*100);
                }
                else if(gameOverReason=="time"){t="â° ì‹œê°„ ì´ˆê³¼"; s="í™ˆìœ¼ë¡œ ì´ë™";} else{t="ğŸ˜­ ì‹¤íŒ¨"; s="í™ˆìœ¼ë¡œ ì´ë™";}
                
                ctx.fillText(t,canvas.width/2,canvas.height/2-40);
                ctx.font="40px 'Jua'"; ctx.fillStyle="#FFD700"; ctx.fillText("ì ìˆ˜: "+score, canvas.width/2, canvas.height/2+20);
                ctx.font="25px 'Jua'"; ctx.fillStyle="#B0BEC5"; ctx.fillText(s,canvas.width/2,canvas.height/2+70);
            }
        }
        
        // ê²Œì„ì˜¤ë²„ ì‹œ í„°ì¹˜ë¡œ í™ˆ ì´ë™
        canvas.addEventListener('touchstart', (e)=>{ if(isGameOver) goToHome(); });

        loop();
    </script>
</body>
</html>
